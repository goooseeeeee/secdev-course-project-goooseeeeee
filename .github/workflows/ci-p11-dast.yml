name: P11 DAST (OWASP ZAP baseline)

on:
  workflow_dispatch:
  push:
    branches: [p11-dast-zap]

jobs:
  dast:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install "uvicorn[standard]"

    - name: Start FastAPI service
      run: |
        mkdir -p EVIDENCE/P11
        uvicorn app.main:app --host 0.0.0.0 --port 8080 &
        for i in {1..30}; do
          curl -sf http://localhost:8080/health && break
          sleep 2
        done

    - name: Run ZAP baseline
      uses: zaproxy/action-baseline@v0.10.0
      with:
        target: 'http://localhost:8080'
        fail_action: false

    - name: Copy ZAP reports to EVIDENCE/P11
      run: |
        mkdir -p EVIDENCE/P11
        cp -r _zap/* EVIDENCE/P11/ || true

    - uses: actions/upload-artifact@v4
      with:
        name: P11_EVIDENCE
        path: EVIDENCE/P11/
