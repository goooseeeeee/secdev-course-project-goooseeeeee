name: P11 DAST (OWASP ZAP baseline)

on:
  workflow_dispatch:
  push:
    branches: [p11-dast-zap]

jobs:
  dast:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install "uvicorn[standard]"

    - name: Start FastAPI service
      run: |
        mkdir -p EVIDENCE/P11
        uvicorn app.main:app --host 0.0.0.0 --port 8080 &
        # Wait for health-check
        for i in {1..30}; do
          curl -sf http://localhost:8080/health && break
          sleep 2
        done

    - name: Run OWASP ZAP baseline scan
      run: |
        docker run --rm -v $PWD/EVIDENCE/P11:/zap/wrk/:rw \
          -t owasp/zap2docker-weekly zap-baseline.py -t http://localhost:8080 -r zap_baseline.html -j zap_baseline.json

    - name: Upload evidence
      uses: actions/upload-artifact@v4
      with:
        name: P11_EVIDENCE
        path: EVIDENCE/P11/
